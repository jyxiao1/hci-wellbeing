<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://download.affectiva.com/js/3.2/affdex.js"></script>
    <style>
        #emoji { font-size:10em; }
    </style>
    <title>Keep Awake</title>
</head>
<body>
<audio id="alarm">
    <source src="gentleAlarm.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>
<a href="index.html">Back to home</a>
<div id='video'></div>
<button onclick="playAudio()" type="button">Play Audio</button>
<div id='isAwake'></div>
<div id='count'></div>

<script>
    var numSecPassedWithEyesClosed = 10;
    var isPlaying = false;
    const wakeupSound = document.getElementById("alarm");

    function playAudio() {
        wakeupSound.play();
        startCamera();
    }


    function startCamera() {
        const videoWidth = 640, videoHeight = 480;
        const faceMode = affdex.FaceDetectorMode.LARGE_FACES;
        const detector = new affdex.CameraDetector(
            document.querySelector('#video'),
            videoWidth, videoHeight, faceMode
        );

        //detector.detectEmotions.joy = true
        detector.detectAllExpressions();

        setInterval(incrementTime, 1000);
        var secondsPassed = 0;
        var prevSecondsPassed = 0;

        function incrementTime() {
            secondsPassed++;
        }

        detector.addEventListener('onImageResultsSuccess', function (faces) {
            if (faces.length > 0 && secondsPassed > prevSecondsPassed) {
                prevSecondsPassed = secondsPassed;

                if (parseFloat(faces[0].expressions.eyeClosure) > 0.3 && numSecPassedWithEyesClosed < 31) {
                    numSecPassedWithEyesClosed++;
                } else if (numSecPassedWithEyesClosed > 0) {
                    numSecPassedWithEyesClosed -= 3;
                }

                if (numSecPassedWithEyesClosed > 15 && !isPlaying) {
                    wakeupSound.play();
                    isPlaying = true;
                } else if (numSecPassedWithEyesClosed < 15) {
                    wakeupSound.pause();
                    wakeupSound.load();
                    isPlaying = false;
                }

                document.querySelector('#isAwake').innerText = parseFloat(faces[0].expressions.eyeClosure);
                document.querySelector('#count').innerText = numSecPassedWithEyesClosed + " seconds";

            }
        });

        detector.start();
    }
</script>
</body>
</html>
