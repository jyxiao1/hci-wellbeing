<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://download.affectiva.com/js/3.2/affdex.js"></script>
    <style>
        #emoji { font-size:10em; }
    </style>
    <title>Keep Awake</title>
</head>
<body>
<audio id="myAudio">
    <source src="gentleAlarm.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>
<div id='video'></div>
<div id='isAwake'></div>
<div id='count'></div>

<script>
    var numSecPassedWithEyesClosed = 10;
    var isPlaying = false;
    const wakeupSound = document.getElementById("myAudio");

    window.onload = function() {
        wakeupSound.play();
        wakeupSound.pause();
    };
        const videoWidth = 640, videoHeight = 480;
        const faceMode = affdex.FaceDetectorMode.LARGE_FACES;
        const detector = new affdex.CameraDetector(
            document.querySelector('#video'),
            videoWidth, videoHeight, faceMode
        );

        //detector.detectEmotions.joy = true
        detector.detectAllExpressions();

        setInterval(incrementTime, 1000);
        var secondsPassed = 0;
        var prevSecondsPassed = 0;

        function incrementTime() {
            secondsPassed++;
        }

        detector.addEventListener( 'onImageResultsSuccess', function( faces ) {
            if( faces.length > 0 && secondsPassed > prevSecondsPassed) {
                prevSecondsPassed = secondsPassed;
                document.querySelector('#isAwake').innerText = parseFloat(faces[0].expressions.eyeClosure);
                document.querySelector('#count').innerText = numSecPassedWithEyesClosed + " seconds";

                if(parseFloat(faces[0].expressions.eyeClosure) > 0.5 && numSecPassedWithEyesClosed < 31)
                {
                    numSecPassedWithEyesClosed ++;
                }
                else if (numSecPassedWithEyesClosed > 0)
                {
                    numSecPassedWithEyesClosed -= 3;
                }

                if(numSecPassedWithEyesClosed > 15 && !isPlaying)
                {
                    wakeupSound.play();
                    isPlaying = true;
                }
                else if(numSecPassedWithEyesClosed < 15)
                {
                    wakeupSound.pause();
                    isPlaying = false;
                }

            }
        });

        detector.start();
    //}
</script>
</body>
</html>
